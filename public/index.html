<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FastPayZone</title>
  <style>
    :root{--bg1:#12002f;--bg2:#240046;--card:rgba(255,255,255,0.06);--btn-grad:linear-gradient(90deg,#9b5bff,#6f2dbd)}
    html,body{height:100%;margin:0;font-family:Inter,Arial,Helvetica;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:#fff;padding:16px}
    .wrap{max-width:920px;margin:0 auto}
    .card{background:var(--card);padding:14px;border-radius:12px;margin-bottom:14px}
    h1{margin:0 0 8px 0;font-size:20px}
    .muted{color:#d8c5ff;font-size:13px}
    input,select{width:100%;padding:10px;border-radius:8px;border:none;margin-top:8px;background:rgba(255,255,255,0.03);color:#fff}
    .btn{display:inline-block;padding:10px 14px;border-radius:10px;color:#fff;text-decoration:none;border:none;cursor:pointer;background:var(--btn-grad);margin-top:8px}
    .row{display:flex;gap:10px}
    @media(max-width:680px){ .row{flex-direction:column} }
    #deposit,#withdraw{display:none;position:fixed;right:12px;bottom:12px;max-width:380px;width:94%}
    .small{font-size:13px;color:#e6dbff}
    #fpz_debug{position:fixed;left:8px;top:8px;z-index:9999;padding:8px;background:rgba(0,0,0,0.55);color:#fff;border-radius:8px;font-size:13px;max-width:calc(100% - 20px);}
    #fpz_debug .line{margin-bottom:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <header class="card">
      <h1>FastPayZone</h1>
      <div class="muted">Wallet · Deposit · Withdraw · Referral</div>
    </header>

    <!-- AUTH -->
    <section id="authCard" class="card">
      <h3>Login / Register</h3>
      <div id="recaptcha-container"></div>

      <label class="small">Phone (with +91)</label>
      <input id="phone" placeholder="+919876543210" />

      <div class="row">
        <input id="otp" placeholder="OTP" />
        <button class="btn" id="verifyBtn" onclick="verifyOTP()">Verify</button>
      </div>

      <div style="margin-top:8px">
        <button class="btn" id="sendBtn" onclick="sendOTP()">Send OTP</button>
        <button class="btn" onclick="googleSign()">Sign in with Google</button>
      </div>
      <div id="authMsg" class="small" style="margin-top:8px"></div>
    </section>

    <!-- USER AREA -->
    <section id="userCard" class="card" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div id="welcome" style="font-weight:700">Welcome</div>
          <div class="small" id="userPhone"></div>
        </div>
        <div style="text-align:right">
          <div class="small">Wallet Balance</div>
          <div id="bal" style="font-weight:800;font-size:18px">₹0.00</div>
        </div>
      </div>

      <div style="margin-top:12px" class="row">
        <button class="btn" onclick="openDeposit()">Deposit</button>
        <button class="btn" onclick="openWithdraw()">Withdraw</button>
        <button class="btn" onclick="logout()">Logout</button>
      </div>

      <div id="userMsg" class="small" style="margin-top:8px"></div>
    </section>

    <footer class="card small">
      Note: Withdrawal fee 10%. For live OTP/Google -> add your domain (fastpayzone.onrender.com) in Firebase Authorized domains.
    </footer>
  </div>

  <!-- DEPOSIT DRAWER -->
  <div id="deposit" class="card">
    <h4>Deposit (Manual UPI)</h4>
    <input id="d_amt" type="number" placeholder="Amount (min 200)" />
    <select id="d_upi">
      <option value="poojamahta67-1@okicici">poojamahta67-1@okicici</option>
      <option value="herry9336@ptyes">herry9336@ptyes</option>
    </select>
    <input id="d_ss" type="file" accept="image/*" />
    <div style="display:flex;gap:8px;margin-top:8px">
      <button class="btn" onclick="submitDeposit()">Submit</button>
      <button class="btn" onclick="closeDeposit()">Close</button>
    </div>
    <div id="d_msg" class="small" style="margin-top:8px"></div>
  </div>

  <!-- WITHDRAW DRAWER -->
  <div id="withdraw" class="card">
    <h4>Withdraw</h4>
    <input id="w_amt" type="number" placeholder="Amount" oninput="calcWithdraw()" />
    <input id="w_upi" placeholder="Payout UPI (example@bank)" />
    <div style="margin-top:8px" class="small">Fee (10%): ₹<span id="w_fee">0</span> — You Get: ₹<span id="w_get">0</span></div>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button class="btn" onclick="submitWithdraw()">Request</button>
      <button class="btn" onclick="closeWithdraw()">Close</button>
    </div>
    <div id="w_msg" class="small" style="margin-top:8px"></div>
  </div>

  <!-- debug box -->
  <div id="fpz_debug"><div class="line"><b>FPZ Debug</b></div><div id="fpz_msgs"></div></div>

  <!-- SCRIPT -->
  <script>
    const API_BASE = "https://fastpayzone.onrender.com";
    let CURRENT_USER = null;

    function dbg(msg){
      console.log('FPZ-DBG:', msg);
      const m = document.getElementById('fpz_msgs');
      if(m) m.innerHTML = (new Date()).toLocaleTimeString() + ' — ' + msg + '<br/>' + m.innerHTML;
    }
    function showAuthMsg(txt){ document.getElementById('authMsg').innerText = txt; dbg(txt); }
    function showUserMsg(txt){ document.getElementById('userMsg').innerText = txt; dbg(txt); }

    function openDeposit(){ document.getElementById('deposit').style.display='block'; }
    function closeDeposit(){ document.getElementById('deposit').style.display='none'; }
    function openWithdraw(){ document.getElementById('withdraw').style.display='block'; calcWithdraw(); }
    function closeWithdraw(){ document.getElementById('withdraw').style.display='none'; }

    function calcWithdraw(){
      const a = Number(document.getElementById('w_amt').value||0);
      const fee = Math.round(a*0.1*100)/100;
      document.getElementById('w_fee').innerText = fee;
      document.getElementById('w_get').innerText = Math.round((a-fee)*100)/100;
    }
  </script>

  <!-- Firebase imports + main auth logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, RecaptchaVerifier, signInWithPhoneNumber, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // --- YOUR FIREBASE CONFIG (use exactly this or replace with your project's) ---
    const firebaseConfig = {
      apiKey: "AIzaSyCzioy8Julx4QfwhQxIGOLo1GRS2PHtBP0",
      authDomain: "fastpayzone.firebaseapp.com",
      projectId: "fastpayzone",
      storageBucket: "fastpayzone.firebasestorage.app",
      messagingSenderId: "236438267358",
      appId: "1:236438267358:web:58de03cc82224e3f3ba94f"
    };
    // --------------------------------------------------------------------------------

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    // initialise recaptcha safely (avoid double-init)
    function initRecaptcha(){
      try{
        if(window.recaptchaVerifier && typeof window.recaptchaVerifier.clear === 'function'){
          // already exists — clear and recreate to be safe
          try{ window.recaptchaVerifier.clear(); }catch(e){ dbg('recap clear err:'+e.message); }
        }
      }catch(e){}
      window.recaptchaVerifier = new RecaptchaVerifier('recaptcha-container', { size: 'invisible' }, auth);
      dbg('recaptchaVerifier created');
    }
    initRecaptcha();

    // helper to format phone: if 10 digits -> add +91
    function normalizePhone(input){
      let v = String(input || '').trim();
      v = v.replace(/\s+/g,'').replace(/[^0-9\+]/g,'');
      if(v.startsWith('0')) v = v.replace(/^0+/, '');
      // if exactly 10 digits, assume India +91
      if(/^\d{10}$/.test(v)) v = '+91' + v;
      // if starts with country code without plus like 9198... add plus
      if(/^[0-9]{11,}$/.test(v) && !v.startsWith('+')) v = '+' + v;
      return v;
    }

    // SEND OTP
    async function sendOTP(){
      const raw = document.getElementById('phone').value;
      const phone = normalizePhone(raw);
      if(!phone){ showAuthMsg('Phone number daalo (+91...)'); return; }
      showAuthMsg('OTP bhej rahe hain to ' + phone + ' ...');

      try{
        // ensure recaptcha is fresh
        try{ if(!window.recaptchaVerifier) initRecaptcha(); }catch(e){ dbg('recap init err:'+e.message); }

        const confirmation = await signInWithPhoneNumber(auth, phone, window.recaptchaVerifier);
        window.confirmationResult = confirmation;
        showAuthMsg('OTP bhej diya gaya. OTP daalkar Verify karo.');
        dbg('confirmationResult set');
        // start a small cooldown on Send button
        cooldownSendBtn();
      }catch(err){
        console.error('sendOTP err', err);
        showAuthMsg('OTP send error: ' + (err.message || err));
        // try recreate recaptcha if something went wrong
        try{ initRecaptcha(); }catch(e){ dbg('recap recreate err:'+e.message); }
      }
    }
    // cooldown to avoid multiple sends
    function cooldownSendBtn(){
      const btn = document.getElementById('sendBtn');
      if(!btn) return;
      btn.disabled = true;
      let sec = 25;
      const orig = btn.innerText;
      btn.innerText = 'Wait ' + sec + 's';
      const t = setInterval(()=>{
        sec--;
        if(sec<=0){ clearInterval(t); btn.disabled=false; btn.innerText = 'Send OTP'; }
        else btn.innerText = 'Wait ' + sec + 's';
      },1000);
    }

    // VERIFY OTP
    async function verifyOTP(){
      const code = document.getElementById('otp').value.trim();
      if(!code){ showAuthMsg('OTP daalo'); return; }
      if(!window.confirmationResult){ showAuthMsg('Please press Send OTP first'); return; }
      showAuthMsg('OTP verify kar rahe hain...');
      try{
        const result = await window.confirmationResult.confirm(code);
        const user = result.user;
        dbg('verify success user: ' + (user.phoneNumber || user.uid || 'user'));
        await registerBackendUser(user);
        onLogin(user);
      }catch(err){
        console.error('verify err', err);
        showAuthMsg('OTP verification failed: ' + (err.message || err));
      }
    }

    // GOOGLE sign-in
    async function googleSign(){
      try{
        const provider = new GoogleAuthProvider();
        const res = await signInWithPopup(auth, provider);
        const user = res.user;
        await registerBackendUser(user);
        onLogin(user);
      }catch(err){
        console.error('google err', err);
        showAuthMsg('Google sign-in error: ' + (err.message || err));
      }
    }

    // backend register
    async function registerBackendUser(firebaseUser){
      const phone = firebaseUser.phoneNumber || firebaseUser.email || 'unknown';
      const name = firebaseUser.displayName || 'User';
      try{
        const r = await fetch(API_BASE + '/api/user/create', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ name, phone })
        });
        const j = await r.json();
        if(j && j.user && j.user.id){
          CURRENT_USER = { uid: firebaseUser.uid, phone, backend_id: j.user.id };
          localStorage.setItem('fpz_user', JSON.stringify(CURRENT_USER));
          dbg('backend created user id='+ j.user.id);
          return;
        }
      }catch(e){
        console.error('registerBackendUser err', e);
      }
      CURRENT_USER = { uid: firebaseUser.uid, phone, backend_id: null };
      localStorage.setItem('fpz_user', JSON.stringify(CURRENT_USER));
    }

    function onLogin(user){
      document.getElementById('authCard').style.display = 'none';
      document.getElementById('userCard').style.display = 'block';
      document.getElementById('welcome').innerText = 'Welcome, ' + (user.displayName || user.phoneNumber || user.email || 'User');
      document.getElementById('userPhone').innerText = user.phoneNumber || user.email || '';
      showAuthMsg('');
      showUserMsg('Logged in');
      const saved = localStorage.getItem('fpz_user');
      if(saved){
        const obj = JSON.parse(saved);
        if(obj.backend_id) fetchUser(obj.backend_id);
      }
    }

    (function restore(){
      const s = localStorage.getItem('fpz_user');
      if(s){
        CURRENT_USER = JSON.parse(s);
        if(CURRENT_USER && CURRENT_USER.backend_id){
          fetchUser(CURRENT_USER.backend_id);
          document.getElementById('authCard').style.display='none';
          document.getElementById('userCard').style.display='block';
          document.getElementById('welcome').innerText = 'Welcome';
          document.getElementById('userPhone').innerText = CURRENT_USER.phone || '';
        }
      }
    })();

    async function fetchUser(backend_id){
      try{
        const r = await fetch(API_BASE + '/api/user/' + backend_id);
        const j = await r.json();
        if(j && j.user){
          document.getElementById('bal').innerText = (j.user.wallet||0).toFixed(2);
        }
      }catch(e){ console.error('fetchUser',e); }
    }

    function logout(){ auth.signOut().then(()=>{ localStorage.removeItem('fpz_user'); location.reload(); }); }

    // deposit / withdraw functions unchanged
    async function submitDeposit(){
      const amt = Number(document.getElementById('d_amt').value||0);
      const upi = document.getElementById('d_upi').value;
      const file = document.getElementById('d_ss').files[0];

      if(!CURRENT_USER || !CURRENT_USER.backend_id){ alert('Please login first'); return; }
      if(!amt || amt < 1){ alert('Enter amount'); return; }
      if(!upi){ alert('Choose UPI'); return; }

      const fd = new FormData();
      fd.append('user_id', CURRENT_USER.backend_id);
      fd.append('amount', amt);
      fd.append('paid_to_upi', upi);
      if(file) fd.append('screenshot', file);

      try{
        const r = await fetch(API_BASE + '/api/deposit/manual', { method:'POST', body: fd });
        const j = await r.json();
        if(j && j.ok){ document.getElementById('d_msg').innerText = 'Deposit submitted — admin will verify.'; closeDeposit(); fetchUser(CURRENT_USER.backend_id); }
        else document.getElementById('d_msg').innerText = 'Deposit error';
      }catch(e){ console.error(e); document.getElementById('d_msg').innerText = 'Network error'; }
    }

    async function submitWithdraw(){
      if(!CURRENT_USER || !CURRENT_USER.backend_id){ alert('Please login first'); return; }
      const amt = Number(document.getElementById('w_amt').value||0);
      const upi = document.getElementById('w_upi').value.trim();
      if(!amt || !upi){ alert('Enter amount and UPI'); return; }

      try{
        const r = await fetch(API_BASE + '/api/withdraw/request', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ user_id: CURRENT_USER.backend_id, amount: amt, payout_upi: upi })
        });
        const j = await r.json();
        if(j && j.ok){ document.getElementById('w_msg').innerText = 'Withdraw requested — admin will process.'; closeWithdraw(); fetchUser(CURRENT_USER.backend_id); }
        else document.getElementById('w_msg').innerText = (j.error || 'Withdraw error');
      }catch(e){ console.error(e); document.getElementById('w_msg').innerText='Network error'; }
    }

  </script>
</body>
</html>
