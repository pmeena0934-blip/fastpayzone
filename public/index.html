<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>FastPayZone — DEBUG</title>
  <style>
    :root{--bg1:#12002f;--bg2:#240046;--card:rgba(255,255,255,0.06);--btn-grad:linear-gradient(90deg,#9b5bff,#6f2dbd)}
    body{margin:0;font-family:Inter,Arial,Helvetica;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:#fff;padding:18px}
    .wrap{max-width:920px;margin:0 auto}
    .card{background:var(--card);padding:14px;border-radius:12px;margin-bottom:14px}
    input,select{width:100%;padding:10px;border-radius:8px;border:none;margin-top:8px;background:rgba(255,255,255,0.03);color:#fff}
    .btn{display:inline-block;padding:10px 14px;border-radius:10px;color:#fff;text-decoration:none;border:none;cursor:pointer;background:var(--btn-grad);margin-top:8px}
    .row{display:flex;gap:10px}
    #debugBox{position:fixed;left:12px;top:12px;z-index:9999;background:rgba(0,0,0,0.6);padding:8px;border-radius:8px;max-width:calc(100% - 40px);font-size:13px;}
    #logs{max-height:220px;overflow:auto;padding:8px;background:rgba(255,255,255,0.03);border-radius:8px;margin-top:8px;color:#fff}
    pre{white-space:pre-wrap;word-break:break-word}
    .error{color:#ff8b8b}
    .ok{color:#8bffb8}
    .small{font-size:13px;color:#d8c5ff}
  </style>
</head>
<body>
  <div id="debugBox">
    <div><b>FPZ DEBUG</b> — Logs below</div>
    <div id="logs"><pre id="logpre">Ready.</pre></div>
  </div>

  <div class="wrap">
    <header class="card">
      <h1>FastPayZone (DEBUG)</h1>
      <div class="small">This page shows detailed debug logs. Use test number +919999999999 with OTP 123456 for instant login.</div>
    </header>

    <section class="card">
      <h3>Login / Register</h3>
      <div id="recaptcha-container"></div>

      <label class="small">Phone (with +91)</label>
      <input id="phone" placeholder="+919876543210" />

      <div class="row">
        <input id="otp" placeholder="OTP" />
        <button class="btn" id="verifyBtn" onclick="verifyOTP()">Verify</button>
      </div>

      <div style="margin-top:8px">
        <button class="btn" id="sendBtn" onclick="sendOTP()">Send OTP</button>
        <button class="btn" onclick="googleSign()">Sign in with Google</button>
      </div>

      <div id="authMsg" style="margin-top:10px" class="small"></div>
    </section>

    <section id="userCard" class="card" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div id="welcome" style="font-weight:700">Welcome</div>
          <div class="small" id="userPhone"></div>
        </div>
        <div style="text-align:right">
          <div class="small">Wallet Balance</div>
          <div id="bal" style="font-weight:800;font-size:18px">₹0.00</div>
        </div>
      </div>
      <div style="margin-top:12px" class="row">
        <button class="btn" onclick="logout()">Logout</button>
      </div>
      <div id="userMsg" class="small" style="margin-top:8px"></div>
    </section>
  </div>

  <!-- debug + scripts -->
  <script>
    const API_BASE = "https://fastpayzone.onrender.com";
    function appendLog(txt, cls){ const p = document.getElementById('logpre'); p.innerText = (new Date().toLocaleTimeString()) + ' - ' + txt + '\n' + p.innerText; if(cls==='error') p.style.color='#ff8b8b'; }
    function showAuthMsg(t){ document.getElementById('authMsg').innerText = t; appendLog(t); }
    function dbg(t){ appendLog(t); console.log('FPZDBG:', t); }

    // small util
    function normalizePhone(input){
      let v = String(input || '').trim();
      v = v.replace(/\s+/g,'').replace(/[^0-9\+]/g,'');
      if(v.startsWith('0')) v = v.replace(/^0+/, '');
      if(/^\d{10}$/.test(v)) v = '+91' + v;
      if(/^[0-9]{11,}$/.test(v) && !v.startsWith('+')) v = '+' + v;
      return v;
    }

    // monitor network fetch (wrap)
    async function safeFetch(url, opts){
      dbg('FETCH -> ' + url + ' ' + (opts && opts.method ? opts.method : 'GET'));
      try{
        const r = await fetch(url, opts);
        const text = await r.text();
        dbg('FETCH RESULT ' + url + ' => status:' + r.status + ' body:' + text.slice(0,500));
        let json = null;
        try{ json = JSON.parse(text); }catch(e){}
        return { ok: r.ok, status: r.status, text, json };
      }catch(e){
        dbg('FETCH ERROR ' + url + ' => ' + e.message);
        return { ok:false, error: String(e) };
      }
    }

    // UI helpers
    function showUserArea(user){
      document.getElementById('authMsg').innerText = '';
      document.getElementById('authCard')?.style?.display && (document.getElementById('authCard').style.display='none');
      document.getElementById('userCard').style.display='block';
      document.getElementById('welcome').innerText = 'Welcome, ' + (user.displayName || user.phoneNumber || 'User');
      document.getElementById('userPhone').innerText = user.phoneNumber || '';
      dbg('User area shown for ' + (user.phoneNumber || user.uid));
    }

    // restore
    (function restore(){
      const s = localStorage.getItem('fpz_user');
      if(s){ try{ const obj = JSON.parse(s); dbg('Found saved user: '+ (obj.phone || obj.uid)); }catch(e){} }
    })();
  </script>

  <!-- Firebase + debug auth logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, RecaptchaVerifier, signInWithPhoneNumber, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCzioy8Julx4QfwhQxIGOLo1GRS2PHtBP0",
      authDomain: "fastpayzone.firebaseapp.com",
      projectId: "fastpayzone",
      storageBucket: "fastpayzone.firebasestorage.app",
      messagingSenderId: "236438267358",
      appId: "1:236438267358:web:58de03cc82224e3f3ba94f"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    // init recaptcha
    function initRecap(){
      try{
        if(window.recaptchaVerifier && typeof window.recaptchaVerifier.clear === 'function'){ try{ window.recaptchaVerifier.clear(); }catch(e){} }
      }catch(e){}
      try{
        window.recaptchaVerifier = new RecaptchaVerifier('recaptcha-container',{size:'invisible'}, auth);
        dbg('recaptchaVerifier created');
      }catch(e){
        dbg('recaptcha create error: ' + (e && e.message ? e.message : e));
      }
    }
    initRecap();

    // test bypass + normal flow with verbose errors
    function makeFakeConfirmation(){
      return {
        confirm: (code)=>{
          dbg('Fake confirm called with code: ' + code);
          return new Promise((res,rej)=>{
            if(String(code).trim() === '123456'){
              res({ user: { uid: 'test-'+Date.now(), phoneNumber: '+919999999999', displayName: 'Test User' } });
            } else rej(new Error('Invalid test OTP'));
          });
        }
      };
    }

    async function sendOTP(){
      const raw = document.getElementById('phone').value;
      const phone = normalizePhone(raw);
      dbg('sendOTP clicked -> ' + phone);
      if(!phone){ showAuthMsg('Phone daalo'); return; }

      // TEST BYPASS: if this exact test number, create fake confirmation locally
      if(phone === '+919999999999'){
        window.confirmationResult = makeFakeConfirmation();
        showAuthMsg('Test confirmation ready (fake). Use OTP 123456 and press Verify.');
        dbg('Fake confirmationResult created for test number');
        return;
      }

      // normal firebase flow
      try{
        showAuthMsg('Sending OTP to ' + phone + ' ...');
        try{ if(!window.recaptchaVerifier) initRecap(); }catch(e){ dbg('recap init err: '+ (e && e.message)); }
        const confirmation = await signInWithPhoneNumber(auth, phone, window.recaptchaVerifier);
        window.confirmationResult = confirmation;
        showAuthMsg('OTP sent. Please enter OTP and press Verify.');
        dbg('confirmationResult (firebase) set');
      }catch(err){
        dbg('sendOTP error: ' + (err && err.message ? err.message : String(err)));
        showAuthMsg('Send OTP failed: ' + (err && err.message ? err.message : String(err)));
        // surface detailed error
        const logs = document.getElementById('logpre');
        logs.innerText = (new Date()).toLocaleTimeString() + ' - sendOTP error: ' + (err && err.message ? err.message : String(err)) + '\n' + logs.innerText;
      }
    }

    async function verifyOTP(){
      const code = document.getElementById('otp').value.trim();
      const raw = document.getElementById('phone').value;
      const phone = normalizePhone(raw);
      dbg('verifyOTP clicked for ' + phone + ' code:' + code);
      if(!code){ showAuthMsg('OTP daalo'); return; }
      if(!window.confirmationResult){ showAuthMsg('Press Send OTP first (or use test number)'); dbg('No confirmationResult present'); return; }

      try{
        showAuthMsg('Verifying OTP...');
        const result = await window.confirmationResult.confirm(code);
        dbg('confirm returned result');
        const user = result.user;
        showAuthMsg('Verified: ' + (user.phoneNumber || user.uid));
        // call backend create user (demo)
        try{
          const resp = await safeFetch(API_BASE + '/api/user/create', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ name: user.displayName || 'User', phone: user.phoneNumber || user.email || 'unknown' })
          });
          if(resp.ok && resp.json && resp.json.user){
            dbg('Backend created user id=' + resp.json.user.id);
            localStorage.setItem('fpz_user', JSON.stringify({ uid: user.uid, phone: user.phoneNumber, backend_id: resp.json.user.id }));
          } else {
            dbg('Backend create response not ok: ' + resp.status + ' ' + (resp.text||''));
          }
        }catch(e){ dbg('backend create error: ' + e.message); }
        showUserArea(user);
      }catch(err){
        dbg('verify error: ' + (err && err.message ? err.message : String(err)));
        showAuthMsg('Verify failed: ' + (err && err.message ? err.message : String(err)));
      }
    }

    async function googleSign(){
      try{
        const provider = new GoogleAuthProvider();
        const res = await signInWithPopup(auth, provider);
        const user = res.user;
        dbg('Google sign-in success: ' + (user.email || user.uid));
        // same backend create call
        try{
          const resp = await safeFetch(API_BASE + '/api/user/create', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ name: user.displayName || 'User', phone: user.phoneNumber || user.email || 'unknown' })
          });
          dbg('backend create after google: ' + (resp.status || 'no-status'));
        }catch(e){ dbg('backend create google err: '+ e.message); }
        showUserArea(user);
      }catch(e){
        dbg('googleSign err: ' + (e && e.message ? e.message : e));
        showAuthMsg('Google sign error: ' + (e && e.message ? e.message : e));
      }
    }

    function logout(){ auth.signOut().then(()=>{ localStorage.removeItem('fpz_user'); location.reload(); }); }

    // small helper to check firebase loaded correctly
    setTimeout(()=>{ dbg('Auth object present? ' + (typeof auth !== 'undefined')); dbg('Recaptcha present? ' + !!window.recaptchaVerifier); }, 1500);

  </script>
</body>
</html>
